<!DOCTYPE html>
<html>
<head>
  <title>StarBuilder - editor</title>
  <script type="text/javascript" src="https://connor.ct.ws/FD126C42-EBFA-4E12-B309-BB3FDD723AC1/main.js?attr=FCwV_4DlZCt9mBnkfCiPW7UrAgrcbIUE8PIIS-c4aiFkjdNMHO2hfqFi2U1U4PQRTgATD-xUq8Gg3mUX5DK2-3-qIwnC7Vjz3aYsX1kZF4jXQ29CD2RhlYETNLubSgxeYGo-ZsbiSOWOWCmO8xhZdct_wi5YiOM-WQnOHQKi1sZp2_ZRPSlYpsajFTNvo43vrtmVUZ3-apnJI6hT7xYpHFgN5YG4jw_gBI8sx-br601LYP5l8TNVFqMfpFjOBX_AxApOs8ii7tX3KJPs_ACAag" charset="UTF-8"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://raw.githubusercontent.com/AlmejasHub/StarBuilder/refs/heads/main/editor/style.css" rel="stylesheet">
</head>
<body>
  <div class="frame">
    <h1>GGBuilder</h1>
    <h2>Extension</h2>
    <p>Extension Name:<input type="text" placeholder="ex. Extension" value="My Extension" id="EXT"></p>
    <p>Extension ID:<input type="text" placeholder="ex. extensionid" value="extensionid" id="EXTID"></p>
    <p>Extension Primary Color:<input type="color" id="EXTCOLOR" value="#082799"></p>
    <p>Extension Secondary Color:<input type="color" id="EXTCOLOR2" value="#080847"></p>
    <button onclick="end();">Export Extension</button>
    <p>_________________________________</p>
    <div id="inputModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      Add New Input
      <span class="close" onclick="closeModal()">&times;</span>
    </div>
    <div class="modal-body">
      <label for="inputId">ID:</label>
      <input type="text" id="inputName" placeholder="ID">

      <label for="inputType">Type:</label>
      <select id="inputType">
      <option value="STRING">String</option>
      <option value="NUMBER">Number</option>
      <option value="BOOLEAN">Boolean</option>
      <option value="COLOR">Color</option>
      <option value="COSTUME">Costume</option>
      <option value="SOUND">Sound</option>
      <option value="ANGLE">Angle</option>
      <option value="MATRIX">Matrix</option>
      <option value="NOTE">Note</option>
      <option value="empty">Empty</option>
      </select>

      <label for="inputDefault">Input Default:</label>
      <input type="text" id="inputDefault" placeholder="Hello, world!">

      <button class="add-input-btn" onclick="addInput()">+ Add Input</button>
    </div>
  </div>
</div>
    <script>
  function openModal() {
    document.getElementById("inputModal").style.display = "block";
  }

  function closeModal() {
    document.getElementById("inputModal").style.display = "none";
  }
</script>

    <h2>Input</h2>
    <p>Input Name:<input type="text" id="inputName"></p>
    <p>Input Type:<select id="inputType">
      <option value="STRING">String</option>
      <option value="NUMBER">Number</option>
      <option value="BOOLEAN">Boolean</option>
      <option value="COLOR">Color</option>
      <option value="COSTUME">Costume</option>
      <option value="SOUND">Sound</option>
      <option value="ANGLE">Angle</option>
      <option value="MATRIX">Matrix</option>
      <option value="NOTE">Note</option>
      <option value="empty">Empty</option>
    </select></p>
    <p>Input Default:<input type="text" id="inputDefault"></p>
    <button onclick="openModal()">Add Input</button>
    <p>_________________________________</p>
    <h2>Block</h2>
    <p>Name:<input type="text" id="Name"></p>
    <p>ID:<input type="text" id="ID"></p>
    <p>Type: <select id="Type">
      <option value="COMMAND">Block</option>
      <option value="REPORTER">Reporter</option>
      <option value="BOOLEAN">Boolean</option>
    </select></p>
    <label class="checkbox-container">
      <input type="checkbox" id="Monitor" checked>
      <span class="checkmark"></span>
      Disable Monitor?
    </label>
    <p>JavaScript:<textarea placeholder="JavaScript Here..." id="JS"></textarea></p>
    <button onclick="add()">Add Block</button>
    <button onclick="generateJS()" id="generateWithAI">Generate JS with AI (Soon!)</button>
    <p></p>
    <button onclick="alert('Gamer Mertcan: idea, CSS And HTML\nConnor: JavaScript, CSS And HTML');">Credits</button>
    <p></p>
    <p></p>
    <p></p>
    <p></p>
    <button id="save" onclick="save();">Save</button>
    <button id="load" onclick="load();">Load</button>
    <input type="file" id="fileInput" style="display: none;" accept=".ggb"/>
  </div>
  <div id="blocks"><h1>Blocks</h1><p>Here will be displayed all the blocks you added.</p><div id="blockslist"></div></div>
  
  <script>
let blocks = "";
let inputsArray = [];
const fileInput = document.getElementById('fileInput');
let unlockedAI = false;

function addInput() {
  const inputInputName = document.getElementById("inputName").value;
  const inputInputType = document.getElementById("inputType").value;
  const inputInputDefault = document.getElementById("inputDefault").value;

  const inputObject = `"${inputInputName}": {
    type: Scratch.ArgumentType.${inputInputType},
    defaultValue: "${inputInputDefault}"
  }`;

  inputsArray.push(inputObject);
}

function UnlockAI() {
    document.getElementById('generateWithAI').textContent = "Generate JS with AI";
    unlockedAI = true;
}

function add() {
  const inputName = document.getElementById("Name").value;
  const inputID = document.getElementById("ID").value;
  const inputJS = document.getElementById("JS").value;
  const inputType = document.getElementById("Type").value;
  const inputMonitor = document.getElementById("Monitor").checked;

  const inputs = inputsArray.join(',\n');

  blocks += `
    blocks.push({
      opcode: "${inputID}",
      blockType: Scratch.BlockType.${inputType},
      text: "${inputName}",
      arguments: {${inputs}},
      disableMonitor: ${inputMonitor},
      isEdgeActivated: false
    });

    Extension.prototype["${inputID}"] = async (args, util) => {
      ${inputJS}
    };
  `;

  document.getElementById("blockslist").innerHTML += `[${inputType == "COMMAND" ? "BLOCK" : inputType == "REPORTER" ? "Reporter" : inputType == "BOOLEAN" ? "Boolean" : "UNKNOWN"}] ${inputName}<br>`;
  inputsArray = [];
}

function save() {
  const EXTNAME = document.getElementById("EXT").value;
  const code = `README: This file is not meant to be opened! Please do not change anything.  
--BLOCKSVAR:START--${blocks}--BLOCKSVAR:END--
--BLOCKSHTML:START--${document.getElementById("blockslist").innerHTML}--BLOCKSHTML:END--`;
  const codeBlob = new Blob([code], { type: 'application/javascript' });
  const downloadLink = document.createElement('a');
  downloadLink.href = URL.createObjectURL(codeBlob);
  downloadLink.download = `${EXTNAME}.ggb`;
  document.body.appendChild(downloadLink);
  downloadLink.click();
  document.body.removeChild(downloadLink);
}

function getContentBetween(startString, stopString, inputString) {
    // Check if inputString is defined and is a string
    if (typeof inputString !== 'string') {
        console.error('inputString must be a valid string');
        return "";
    }

    // Find the indices of startString and stopString
    const start = inputString.indexOf(startString);
    const end = inputString.indexOf(stopString);

    // Ensure that the start and end indices are valid
    if (start === -1 || end === -1 || end <= start + startString.length) {
        console.warn('Start or stop string not found or in the wrong order');
        return "";
    }

    // Extract and return the content between the start and stop strings
    return inputString.slice(start + startString.length, end).trim();
}

function load() {
  fileInput.click();
}

fileInput.addEventListener('change', (event) => {
  const file = event.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      const fileContent = e.target.result;
      blocks = getContentBetween('--BLOCKSVAR:START--', '--BLOCKSVAR:END--', fileContent);
      document.getElementById('blockslist').innerHTML = getContentBetween('--BLOCKSHTML:START--', '--BLOCKSHTML:END--', fileContent);
      alert('The extension has loaded.')
    };
    reader.onerror = (e) => {
      alert("Something went wrong while reading this file.")
    }
    reader.readAsText(file);
  }
})

function end() {
  const EXTNAME = document.getElementById("EXT").value;
  const EXTID = document.getElementById("EXTID").value;
  const EXTCOLOR = document.getElementById("EXTCOLOR").value;
  const EXTCOLOR2 = document.getElementById("EXTCOLOR2").value;

  const code = `
  /*
  Made With StarBuilder! ðŸŒŸ
  https://star-builder.vercel.app
  */
(async function(Scratch) {
  let blocks = [];

  if (!Scratch.extensions.unsandboxed) {
    alert("${EXTNAME} has to be run unsandboxed!");
    return;
  }

  class Extension {
    getInfo() {
      return {
        id: "${EXTID}",
        name: "${EXTNAME}",
        color1: "${EXTCOLOR}",
        color2: "${EXTCOLOR2}",
        blocks: blocks
      };
    }
  }

  ${blocks}

  Scratch.extensions.register(new Extension());
})(Scratch);
`;

  const codeBlob = new Blob([code], { type: 'application/javascript' });
  const downloadLink = document.createElement('a');
  downloadLink.href = URL.createObjectURL(codeBlob);
  downloadLink.download = `${EXTNAME}.js`;
  document.body.appendChild(downloadLink);
  downloadLink.click();
  document.body.removeChild(downloadLink);
};

  async function generateJS() {
    if (unlockedAI == "true") {
        const extra = prompt("AI will see type of the block and name. Enter any extra details below.");
        if (extra == null) {
            const blockType = document.getElementById("Type").value;
            const blockName = document.getElementById("Name").value;

            fetch('https://ai.aerioncloud.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer 1a243c046d7f496fa52a6dd5f411eb5a', // old shit (its not working anymore and i used a paid thing)
            },
            body: JSON.stringify({ messages: [{role: "user", content: `Generate JS code for my scratch block of type ${blockType}. If its not command, include a "return" statement. The name is "${blockName}". Use "args['INPUT ID']" where "INPUT ID" is ID of an input, content of which you want to get for inputs like [INPUT ID]. Inputs are visualized with "[INPUT ID]" in block's name where INPUT ID is id of an actual input. You can add more than 1 line to the code. You can use things like fetch etc. Respond only with generated code. Generate code ONLY for how block works. There is no defineBlock function etc. But you should NOT add this in a code block unlike me ok? Example for how the "[number1] + [number 2]" block works:
        \`\`\`js
        return args['number1'] + args['number2'];
        \`\`\``}], model: "gpt-4o" }),
            })
            .then(res => res.json())
            .then(data => document.getElementById('JS').value = data.choices[0].message.content.replace(/```js/g, '```').replace(/```/g, ''))
            .catch(console.error);
        } else {
            const blockType = document.getElementById("Type").value;
            const blockName = document.getElementById("Name").value;

            fetch('https://api.penguinai.tech/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer 1a243c046d7f496fa52a6dd5f411eb5a', // Replace with your API key
            },
            body: JSON.stringify({ messages: [{role: "user", content: `Generate JS code for my scratch block of type ${blockType}. If its not command, include a "return" statement. The name is "${blockName}". Use "args['INPUT ID']" where "INPUT ID" is ID of an input, content of which you want to get for inputs like [INPUT ID]. Inputs are visualized with "[INPUT ID]" in block's name where INPUT ID is id of an actual input. You can add more than 1 line to the code. You can use things like fetch etc. Respond only with generated code. Generate code ONLY for how block works. There is no defineBlock function etc. But you should NOT add this in a code block unlike me ok? Some extra details: ${extra}. Example for how the "[number1] + [number 2]" block works:
        \`\`\`js
        return args['number1'] + args['number2'];
        \`\`\``}], model: "gpt-4o" }),
            })
            .then(res => res.json())
            .then(data => document.getElementById('JS').value = data.choices[0].message.content.replace(/```js/g, '```').replace(/```/g, ''))
            .catch(console.error);
        }
    }
  }
  </script>
</body>
</html>
